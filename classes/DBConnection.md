[**Portalscript API (internal)**](../README.md)

***

[Portalscript API (internal)](../globals.md) / DBConnection

# Class: DBConnection

This class allows you to connect to a database and execute SQL statements.  

**Important:** For reading the result of a SELECT statement, the class [DBResultSet](../interfaces/DBResultSet.md) is used. A DBConnection object can only be used for one DBResultSet object. 
Meaning, if you want to create another DBResultSet object you must also create an additional DBConnection object.

You can connect to the Documents or any other database. **See the [constructor](#constructor) descriptions for further information.**

## Methods

### close()

> **close**(): `boolean`

**Close the database connection and free the server ressources.**  

**Note:** It is strongly recommanded to close each DBConnection object you have created, 
since database connections are so-called expensive ressources and should be used carefully.

#### Returns

`boolean`

`true` if successful, `false` in case of any error

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBResultSet.close](../interfaces/DBResultSet.md#close)

***

### executeQuery()

> **executeQuery**(`sqlStatement`): [`DBResultSet`](../interfaces/DBResultSet.md)

**Execute a SELECT statement and retrieve a [DBResultSet](../interfaces/DBResultSet.md) containing the result rows.**  

**Note:** This instruction should only be used to SELECT on the external database, since the method always tries to create a DBResultSet. 
If you need to execute different SQL statements, refer to the [DBConnection.executeStatement()](#executestatement) method.  

**Note:** x64/UTF-8 DOCUMENTS version: since DOCUMENTS 4.0a HF2 the method handles the statement as UTF-8-String

#### Parameters

##### sqlStatement

`string`

String containing the SELECT statement you want to execute in the database

#### Returns

[`DBResultSet`](../interfaces/DBResultSet.md)

DBResultSet containing the result rows generated by the SELECT instruction

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBConnection.executeStatement](#executestatement)

***

### ~~executeQueryUC()~~

> **executeQueryUC**(`sqlStatement`): [`DBResultSet`](../interfaces/DBResultSet.md)

**Execute a SELECT statement using a x64/UTF-8 DOCUMENTS and retrieve a [DBResultSet](../interfaces/DBResultSet.md) containing the result rows.**  

**Note:** This instruction should only be used to SELECT on the external database, since the method always tries to create a DBResultSet. 
If you need to execute different SQL statements, refer to the [DBConnection.executeStatement()](#executestatement) method.

#### Parameters

##### sqlStatement

`string`

String containing the SELECT statement you want to execute in the database

#### Returns

[`DBResultSet`](../interfaces/DBResultSet.md)

DBResultSet containing the result rows generated by the SELECT instruction

#### Since

DOCUMENTS 4.0

#### See

[DBConnection.executeStatementUC](#executestatementuc)

#### Deprecated

since DOCUMENTS 4.0a HF2, use [DBConnection.executeQuery()](#executequery) instead

***

### executeStatement()

> **executeStatement**(`sqlStatement`): `boolean`

**Execute any SQL statement on the external database.**  

You can execute any SQL statement, as long as the database driver used for the connection supports the type of instruction. 
Use this method especially if you want to INSERT or UPDATE or DELETE data rows in tables of the external database. 
If you need to SELECT table rows, refer to the [DBConnection.executeQuery()](#executequery) method.  

**Note:** x64/UTF-8 DOCUMENTS version: since DOCUMENTS 4.0a HF2 the method handles the statement as UTF-8-String

#### Parameters

##### sqlStatement

`string`

#### Returns

`boolean`

`true` if successful, `false` in case of any error

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBConnection.executeQuery](#executequery)

***

### ~~executeStatementUC()~~

> **executeStatementUC**(`sqlStatement`): `boolean`

**Execute any SQL statement using a x64/UTF-8 DOCUMENTS on the external database.**  

You can execute any SQL statement, as long as the database driver used for the connection supports the type of instruction. 
Use this method especially if you want to INSERT or UPDATE or DELETE data rows in tables of the external database. 
If you need to SELECT table rows, refer to the DBConnection.executeQueryUC() method.

#### Parameters

##### sqlStatement

`string`

#### Returns

`boolean`

`true` if successful, `false` in case of any error

#### Since

DOCUMENTS 4.0

#### See

[DBConnection.executeQueryUC](#executequeryuc)

#### Deprecated

since DOCUMENTS 4.0a HF2, use [DBConnection.executeStatement()](#executestatement) instead

***

### getLastError()

> **getLastError**(): `string`

**Function to get the description of the last error that occurred.**

#### Returns

`string`

Text of the last error as String

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DocFile.getLastError](../interfaces/DocFile.md#getlasterror)

## Constructors

### Constructor

> **new DBConnection**(): `DBConnection`

**Connect to DOCUMENTS database.**  

This is the constructor with no parameters. It can only be used to get a connection to the DOCUMENTS database.

#### Returns

`DBConnection`

#### Since

DOCUMENTS 4.0

#### See

[DBResultSet](../interfaces/DBResultSet.md)

### Constructor

> **new DBConnection**(`dbType?`, `dbName?`, `dbUser?`, `password?`): `DBConnection`

**Connect to MySQL - DOCUMENTS DB is MySQL.**  
 
If your DOCUMENTS database is a MySQL compatible database, you can connect to any other MySQL compatible database using the following parameters.

#### Parameters

##### dbType?

`string`

The type of database to connect to, which is identical to the DOCUMENTS database type. The value must be `"mysql"`.

##### dbName?

`string`

The name of the database to connect to. E.g. `"mydatabase"`. The default host name is `localhost`. Another host name or IP address 
can be specified like `"mydatabase@ip-address"`.  
Examples: `"mydatabase@remote.example.com"`, `"mydatabase@123.123.12.1"`.  
To connect to a remote database, the remote database server must be configured for remote access. The configuration for remote access is not the default for the database server.

##### dbUser?

`string`

The login name of a user that exists on the database server and has access to the database. If this is the user of the DOCUMENTS database, you can omit this parameter.

##### password?

`string`

The password of the database user in plain text. If the user is the user of the DOCUMENTS database, you can omit this parameter.

#### Returns

`DBConnection`

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBResultSet](../interfaces/DBResultSet.md)

#### Example

```ts
var testDB = new DBConnection("mysql", "testdb@123.123.12.1", "testuser", "testpw");
if (testDB && testDB.getLastError() == null)
{
  var myRS = testDB.executeQuery("SELECT * FROM testtbl");
  // ...
}
```

### Constructor

> **new DBConnection**(`dbType?`, `connectionString?`): `DBConnection`

**Connect to SQL Server - DOCUMENTS DB is SQL Server.**  
 
If your DOCUMENTS database is SQL Server, you can connect to any other SQL Server database using the following parameters.

#### Parameters

##### dbType?

`string`

The type of database to connect to, which is identical to the DOCUMENTS database type. The value must be `odbc` (or `sqlserver`, it's the same).

##### connectionString?

`string`

All other information about the database, including information about the credentials, must be specified in a **Connection String** 
which is passed via the second parameter. See this [Connection Strings Reference](https://www.connectionstrings.com/sql-server/).  
It is highly recommended, to use an ODBC driver to connect to the database.  
**OBDC drivers**  
Open the **Drivers** tab in [ODBC Data Source Administrator](https://docs.microsoft.com/en-us/sql/odbc/admin/odbc-data-source-administrator) 
on your DOCUMENTS maschine to see a list of available drivers. Microsoft recommends to use **Microsoft ODBC Driver for SQL Server** 
([in this documentation](https://docs.microsoft.com/en-us/sql/connect/connect-history)) which is called **ODBC Driver XX for SQL Server** 
in the list (XX replaced by version). See example.

#### Returns

`DBConnection`

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBResultSet](../interfaces/DBResultSet.md)

#### Example

```ts
var connectionString = "Driver={ODBC Driver 17 for SQL Server};Server=myServerAddress;Database=myDataBase;UID=myUsername;PWD=myPassword;";
var myDB = new DBConnection("odbc", connectionString);
```

### Constructor

> **new DBConnection**(`connType?`, `connString?`, `dbUser?`, `password?`): `DBConnection`

**Connection to arbitrary database via ODBC and DSN.**  

This constructor can be used to create a connection to any database for which an ODBC driver is available.   
 
**Example: Conntection to SQL Server via DSN, if the DOCUMENTS database is SQL Server**  

Using the wizard in the [ODBC Data Source Administrator](https://docs.microsoft.com/en-gb/sql/odbc/admin/odbc-data-source-administrator), 
you can configure a User- or System-DSN. If you have configured e.g. the DSN `myDSN`, then you can access the configured database like 
in the second example (see below). If the user is not the DOCUMENTS database user, you must set the `dbUser` and `password` parameters, 
even if it is configured in the Data Source Name.  
 
**Example: Connection to MariaDB via ODBC from DOCUMENTS on Linux/Windows**  

Linux: The ODBC Driver Manager package unixODBC can easily be installed using the package manager APT (you may also need to install libodbc1.).  
Windows: [ODBC Data Source Administrator](https://docs.microsoft.com/en-gb/sql/odbc/admin/odbc-data-source-administrator) is required.  
Linux/Windows: The MariaDB Connector/ODBC is required. Read [this chapter](https://mariadb.com/kb/en/about-mariadb-connector-odbc/#installing-mariadb-connectorodbc) to install MariaDB Connector (Driver)
and [this chapter](https://mariadb.com/kb/en/creating-a-data-source-with-mariadb-connectorodbc/) to create a Data Source.  
 
**Example: Connection to SQL Server via ODBC from DOCUMENTS on Linux**  

If your DOCUMENTS installation is on a Linux system, the type of your DOCUMENTS database is `mysql`. So if you want to access a database on SQL Server, then you must 
[install the ODBC Driver for SQL Server on your Linux machine](https://docs.microsoft.com/en-us/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server). 
The ODBC Driver Manager package unixODBC can easily be installed using the package manager APT (see note). For testing your database connection independent of PortalScripting, 
you can use [isql](https://turbodbc.readthedocs.io/en/latest/pages/troubleshooting.html#testing-your-odbc-configuration). After installing the ODBC Driver and 
the ODBC Driver Manager you must configure a Data Source Name (DNS) in the `odbc.ini` file (exenal documentations 
[Microsoft](https://docs.microsoft.com/en-us/sql/connect/odbc/linux-mac/connection-string-keywords-and-data-source-names-dsns?view=sql-server-ver15), 
[turbodbc](https://turbodbc.readthedocs.io/en/latest/pages/odbc/driver_manager_config.html#odbc-configuration-files)). Then you can access the database 
using the Data Source Name (see first example below).  
 
**Note: Remote SQL Server**  

To connect to a remote SQL Server, you may have to 
[enable the TCP/IP protocol in SQL Server Configuration Manager](https://docs.microsoft.com/en-gb/sql/database-engine/configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port) 
and to open the port in the firewall on the remote SQL Server host.

#### Parameters

##### connType?

`string`

This value must be `"odbc"`. The database will be accessed using a standard API for databases, called Open Database Connectivity (ODBC). 
An ODBC driver for the database must be available and it must be installed on the DOCUMENTS host.

##### connString?

`string`

The **Data Source Name (DSN)** or the complete **Connection String**.  
An ODBC Driver Manager can or sometimes must be used to specify a Data Source Name (DSN). 
([Microsoft Documentation](https://docs.microsoft.com/en-gb/sql/odbc/microsoft-open-database-connectivity-odbc)). A Data Source Name allows you 
to store all required connection information to a database in a specific place (like the `odbc.ini` on Linux or a registry entry on Windows). 
So it is possible to connect to the defined database only by the name.  
Another option is to put all the information in one string, called **Connection String**. The Connection String can only be used if the DOCUMENTS database is SQL Server.

##### dbUser?

`string`

The login name of a database user who has been granted access to the database.

##### password?

`string`

The password of the database user in plain text.

#### Returns

`DBConnection`

#### Since

ELC 3.50 / otrisPORTAL 5.0

#### See

[DBResultSet](../interfaces/DBResultSet.md)

#### Examples

```ts
// First example: using Data Source Name
var dataSourceName = "myDSN";
var dbUser = "test";
var password = "test";
var myDB = new DBConnection("odbc", dataSourceName, user, password);
```

```ts
// Third example: using DBConnection together with DBResultset
var myDB = null;
var myRS = null;
try {
   // create DB-Connection using the Data Source Name "Nordwind"
   myDB = new DBConnection("odbc", "Nordwind");
   if (myDB.getLastError() != null)
      throw "Error connection the database: " + myDB.getLastError();
   // executeQuery returns a DBResultSet
   myRS = myDB.executeQuery("SELECT Nachname, Vorname FROM Personal");
   if (!myRS)
      throw "Error in SELECT statement: " + myDB.getLastError();
   // read all persons from the result set
   while (myRS.next()) {
      var fullName = myRS.getString(0) + ", " + myRS.getString(1);
      // Fails, because you must read the columns in the correct order!
      //var fullName = myRS.getString(1) + ", " + myRS.getString(0);
      // Fails, because it is not allowed to read a value twice!
      //var fullName = myRS.getString(0) + ", " + myRS.getString(0);
      util.out(fullName);
   }
} catch (err) {
   util.out(err);
} finally {
    // Important: free resources!
    if (myRS)
       myRS.close();
    if (myDB)
       myDB.close();
}
```
